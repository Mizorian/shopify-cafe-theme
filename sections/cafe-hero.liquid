{% comment %}
  Secci√≥n Profesional: Caf√© Hero con AJAX, Metafields y Dise√±o Boutique.
{% endcomment %}

{{ 'cafe-brand.css' | asset_url | stylesheet_tag }}

<section class="cafe-hero-section" style="background-color: {{ section.settings.bg_color }};">
  <div class="cafe-hero-wrapper">
    
    <div class="cafe-hero-info">
      <span class="cafe-eyebrow">{{ section.settings.badge_text }}</span>
      <h1 class="cafe-hero-title">{{ section.settings.title }}</h1>
      <div class="cafe-hero-desc">{{ section.settings.description }}</div>

      {%- assign product = section.settings.featured_product -%}
      
      {%- if product != blank -%}
        <div class="cafe-product-card">
          <h2 class="cafe-product-title">{{ product.title }}</h2>
          <p class="cafe-product-price">{{ product.price | money }}</p>

          <div class="cafe-badges-container">
            {% if product.metafields.custom.origen != blank %}
              <span class="cafe-badge-item">üìç {{ product.metafields.custom.origen }}</span>
            {% endif %}
            {% if product.metafields.custom.tueste != blank %}
              <span class="cafe-badge-item">üî• {{ product.metafields.custom.tueste }}</span>
            {% endif %}
          </div>

          {% if product.available %}
            <div class="cafe-variants-picker">
              <p class="picker-label">Selecciona tu molido:</p>
              <div class="pills-grid">
                {% for variant in product.variants %}
                  <div class="pill-option">
                    <input type="radio" id="var-{{ variant.id }}" name="variant_id" value="{{ variant.id }}" {% if forloop.first %}checked{% endif %}>
                    <label for="var-{{ variant.id }}">{{ variant.title }}</label>
                  </div>
                {% endfor %}
              </div>
            </div>

            <button type="button" class="cafe-btn-primary" onclick="addCafeToCart(this)">
              <span class="btn-text">A√±adir a la molienda</span>
              <div class="btn-loader"></div>
            </button>
          {% else %}
            <div class="cafe-out-of-stock">Este caf√© est√° reposando (Agotado)</div>
          {% endif %}
        </div>
      {%- else -%}
        <div class="cafe-placeholder-msg">Selecciona un producto en el panel de Shopify para activar la secci√≥n.</div>
      {%- endif -%}
    </div>

    <div class="cafe-hero-media">
      {%- if product.featured_image != blank -%}
        <div class="image-container">
          <img src="{{ product.featured_image | img_url: '1000x' }}" alt="{{ product.title }}">
        </div>
      {%- else -%}
        {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
      {%- endif -%}
    </div>

  </div>
</section>

<script>
function addCafeToCart(btn) {
  const variantId = document.querySelector('input[name="variant_id"]:checked').value;
  btn.classList.add('loading');
  
  let formData = { 'items': [{ 'id': variantId, 'quantity': 1 }] };

  fetch(window.Shopify.routes.root + 'cart/add.js', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(formData)
  })
  .then(res => res.json())
  .then(data => {
    btn.classList.remove('loading');
    btn.querySelector('.btn-text').innerText = '¬°A√±adido con √©xito!';
    setTimeout(() => { btn.querySelector('.btn-text').innerText = 'A√±adir a la molienda'; }, 3000);
    // Actualiza el carrito de Dawn
    document.documentElement.dispatchEvent(new CustomEvent('cart:refresh', { bubbles: true }));
  })
  .catch(err => {
    console.error(err);
    btn.classList.remove('loading');
  });
}
</script>

{% schema %}
{
  "name": "Caf√© Hero Especial",
  "settings": [
    { "type": "text", "id": "badge_text", "label": "Texto Superior", "default": "Cosecha de Temporada" },
    { "type": "text", "id": "title", "label": "T√≠tulo Principal", "default": "El aroma de lo aut√©ntico" },
    { "type": "richtext", "id": "description", "label": "Descripci√≥n", "default": "<p>Tostado artesanalmente en peque√±os lotes.</p>" },
    { "type": "product", "id": "featured_product", "label": "Producto" },
    { "type": "color", "id": "bg_color", "label": "Color de Fondo", "default": "#fdfaf7" }
  ],
  "presets": [{ "name": "Caf√© Hero Especial" }]
}
{% endschema %}